
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- REGLAS PRINCIPALES ---

    // Colección de Usuarios
    match /users/{userId} {
      // ✅ CORRECCIÓN: Cualquier usuario autenticado puede leer perfiles.
      // Esto es necesario para mostrar nombres, avatares, etc. en toda la app.
      allow read: if isAuthenticated();
      // Solo el dueño del perfil puede modificarlo.
      allow write: if isOwner(userId);
    }
    
    // Colección de Jugadores
    match /players/{playerId} {
      allow read: if isAuthenticated();
      // El dueño del perfil de jugador puede modificarlo.
      allow write: if isOwner(playerId);
    }

    // Subcolección de historial de OVR (solo escritura desde el servidor)
    match /players/{playerId}/ovrHistory/{historyId} {
      allow read: if isAuthenticated();
      allow write: if false; 
    }

    // Colección de Grupos
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(request.resource.data.ownerUid);
      // Solo el dueño del grupo puede actualizarlo o borrarlo.
      // NOTA: La gestión de roles (memberRoles) se maneja en Server Actions.
      // Los permisos granulares (admin, moderator, member) se verifican allí.
      // Roles disponibles:
      //   - admin: Control total del grupo
      //   - moderator: Gestiona partidos y contenido
      //   - member: Acceso básico de lectura
      allow update, delete: if isOwner(get(/databases/$(database)/documents/groups/$(groupId)).data.ownerUid);
    }

    // Colección de Canchas (Venues)
    match /venues/{venueId} {
      // Cualquier usuario autenticado puede leer canchas
      allow read: if isAuthenticated();
      // La creación/edición/eliminación se maneja en Server Actions con permisos de grupo
      allow write: if false;
    }
    
    // Colección de Equipos Persistentes
    match /teams/{teamId} {
        allow read: if isAuthenticated();
        // Solo el creador del equipo puede gestionarlo
        allow create: if isAuthenticated() && isOwner(request.resource.data.createdBy);
        allow update, delete: if isOwner(get(/databases/$(database)/documents/teams/$(teamId)).data.createdBy);

        // Subcolección de invitaciones
        match /invitations/{invitationId} {
            allow read: if isAuthenticated();
            // Permisos simplificados: autenticación + lógica de negocio en Server Actions
            allow write: if isAuthenticated();
        }
    }

    // Colección de Partidos
    match /matches/{matchId} {
      // ✅ REGLA ABIERTA: Cualquier usuario autenticado puede leer/escribir.
      // La lógica de negocio y permisos se maneja en las Server Actions.
      // Esto simplifica enormemente las reglas y evita errores de permisos en el cliente.
      allow read, write: if isAuthenticated();

      // Subcolecciones de partido (invitations, dateProposals, etc.)
      // - invitations: Respuestas de jugadores (confirmed/declined/maybe/pending)
      // - dateProposals: Propuestas de fechas alternativas con votación
      match /{subcollection}/{docId} {
        allow read, write: if isAuthenticated();
      }
    }

    // --- MONETIZACIÓN ---

    // Paquetes de créditos (solo lectura para usuarios)
    match /creditPackages/{packageId} {
      allow read: if true;  // Públicos para mostrar en la tienda
      allow write: if false; // Solo admin/server puede crear/modificar
    }

    // Transacciones de compra (privadas, solo server-side)
    match /creditTransactions/{transactionId} {
      // Solo el usuario dueño puede leer su propia transacción
      allow read: if isAuthenticated() &&
                     request.auth.uid == resource.data.userId;
      // Solo server-side puede crear/actualizar
      allow write: if false;
    }

    // Regla de comodín final, un poco más restrictiva.
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
