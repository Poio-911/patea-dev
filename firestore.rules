
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- REGLAS PRINCIPALES ---

    // Colección de Usuarios
    match /users/{userId} {
      // ✅ CORRECCIÓN: Cualquier usuario autenticado puede leer perfiles.
      // Esto es necesario para mostrar nombres, avatares, etc. en toda la app.
      allow read: if isAuthenticated();
      // Solo el dueño del perfil puede modificarlo.
      allow write: if isOwner(userId);
    }
    
    // Colección de Jugadores
    match /players/{playerId} {
      allow read: if isAuthenticated();
      // El dueño del perfil de jugador puede modificarlo.
      allow write: if isOwner(playerId);
    }

    // Subcolección de historial de OVR (solo escritura desde el servidor)
    match /players/{playerId}/ovrHistory/{historyId} {
      allow read: if isAuthenticated();
      allow write: if false; 
    }

    // Colección de Grupos
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(request.resource.data.ownerUid);
      // Solo el dueño del grupo puede actualizarlo o borrarlo.
      allow update, delete: if isOwner(get(/databases/$(database)/documents/groups/$(groupId)).data.ownerUid);
    }
    
    // Colección de Equipos Persistentes
    match /teams/{teamId} {
        allow read: if isAuthenticated();
        // Solo el creador del equipo puede gestionarlo
        allow create: if isAuthenticated() && isOwner(request.resource.data.createdBy);
        allow update, delete: if isOwner(get(/databases/$(database)/documents/teams/$(teamId)).data.createdBy);

        // Subcolección de invitaciones
        match /invitations/{invitationId} {
            allow read: if isAuthenticated();
            // ✅ CORRECCIÓN: Ahora cualquier miembro del equipo desafiado puede aceptar/rechazar.
            allow update: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.toTeamId)).data.members.map(member => member.playerId);
            // Solo el creador del desafío (dueño del equipo desafiante) puede crear/borrar invitaciones.
            allow create: if isOwner(get(/databases/$(database)/documents/teams/$(request.resource.data.fromTeamId)).data.createdBy);
            allow delete: if isOwner(get(/databases/$(database)/documents/teams/$(resource.data.fromTeamId)).data.createdBy);
        }
    }

    // Colección de Partidos
    match /matches/{matchId} {
      // ✅ REGLA ABIERTA: Cualquier usuario autenticado puede leer/escribir. 
      // La lógica de negocio y permisos se maneja en las Server Actions.
      // Esto simplifica enormemente las reglas y evita errores de permisos en el cliente.
      allow read, write: if isAuthenticated();

      // Subcolecciones de partido
      match /{subcollection}/{docId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Regla de comodín final, un poco más restrictiva.
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
